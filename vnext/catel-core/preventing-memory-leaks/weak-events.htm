<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
<!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Weak events - Catel documentation</title>
    <link rel="shortcut icon" href="../../favicon.ico">
    <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../css/theme_colors.css" type="text/css" />
    <link rel="stylesheet" href="../../css/styles/vs.css">
    <link rel="stylesheet" href="../../css/font-awesome.4.5.0.min.css">
</head>
<body role="document">
    <div class="grid-for-nav">
        <nav data-toggle="nav-shift" class="nav-side stickynav">
            <div class="side-nav-search">
                <a href="../../index.htm"><i class="fa fa-home"></i> Catel documentation</a>
                <div role="search">
                    <form id="search-form" class="form" action="../../Docnet_search.htm" method="get">
                        <input type="text" name="q" placeholder="Search docs" />
                    </form>
                </div>
            </div>
            <div class="menu menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
<ul>
<li class="tocentry"><a href="../../Home.htm">Home</a>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../Introduction.htm">Introduction</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../FAQ.htm">FAQ</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../Setup,deployment&projects.htm">Setup, deployment & projects</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../Gettingstarted.htm">Getting started</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../Examples.htm">Examples</a></span>
</li>
<li class="tocentry">
<ul>
<li><span class="navigationgroup"><i class="fa fa-caret-down"></i> <a href="../../CatelCore.htm">Catel.Core</a></span></li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../ApiCop.htm">ApiCop</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../catel-core/argument-checking/index.htm">Argument checking</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../catel-core/caching/index.htm">Caching</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../catel-core/configuration/index.htm">Configuration</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../Datahandling.htm">Data handling</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../Exceptionhandling.htm">Exception handling</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../IoC(ServiceLocator&TypeFactory).htm">IoC (ServiceLocator & TypeFactory)</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../Logging.htm">Logging</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../Messaging.htm">Messaging</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../Multilingual.htm">Multilingual</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../Parallelinvocation&tasks.htm">Parallel invocation & tasks</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../Pooling.htm">Pooling</a></span>
</li>
<li class="tocentry">
<ul>
<li><span class="navigationgroup"><i class="fa fa-caret-down"></i> <a href="../../Preventingmemoryleaks.htm">Preventing memory leaks</a></span></li>
<li class="tocentry"><a href="../../catel-core/preventing-memory-leaks/change-notification-wrapper.htm">Change notification wrapper</a>
</li>
<li class="tocentry current"><a class="current" href="../../catel-core/preventing-memory-leaks/weak-events.htm">Weak events</a>
<ul class="currentrelative">
<li class="tocentry"><a href="#open-instance-delegates">Open instance delegates</a></li>
<li class="tocentry"><a href="#weak-references">Weak references</a></li>
<li class="tocentry"><a href="#what-does-it-support">What does it support</a></li>
<li class="tocentry"><a href="#what-does-it-not-support-and-what-are-the-downsides">What does it not support and what are the downsides</a></li>
<li class="tocentry"><a href="#how-to-use">How to use</a></li>
</ul>

</ul>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../Reflection.htm">Reflection</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../Scoping.htm">Scoping</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../Serialization.htm">Serialization</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../Validation.htm">Validation</a></span>
</li>

</ul>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../CatelMVVM.htm">Catel.MVVM</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../tips-tricks/index.htm">Tips & tricks</a></span>
</li>

</ul>
				<div class="toc-footer">
					<span class="text-small">
						<hr/>
						<a href="https://github.com/FransBouma/DocNet" target="_blank">Made with <i class="fa fa-github"></i> DocNet</a>
					</span>
				</div>	
			</div>
            &nbsp;
        </nav>
        <section data-toggle="nav-shift" class="nav-content-wrap">
            <nav class="nav-top" role="navigation" aria-label="top navigation">
                <i data-toggle="nav-top" class="fa fa-bars"></i>
                <a href="../../index.htm">Catel documentation</a>
            </nav>
            <div class="nav-content">
                <div role="navigation" aria-label="breadcrumbs navigation">
                    <div class="breadcrumbs">
<ul><li><a href="../../Home.htm">Home</a></li> / <li><a href="../../CatelCore.htm">Catel.Core</a></li> / <li><a href="../../Preventingmemoryleaks.htm">Preventing memory leaks</a></li> / <li><a href="../../catel-core/preventing-memory-leaks/weak-events.htm">Weak events</a></li></ul>
					
                    </div>
                    <hr />
                </div>
                <div role="main">
                    <div class="section">
<h1 id="weak-events">Weak events<a class="headerlink" href="#weak-events" title="Permalink to this headline"><i class="fa fa-link" aria-hidden="true"></i></a></h1>
<p>You have probably heard about weak events before. This documentation is not about the issue of the cause of weak events, there are lots of articles about that. This documentation writes about the solution, which is the WeakEventListener. Shortly said, when you do this in every class (just for the sake of explaining the problem, don’t start thinking this code has no business value):</p>
<pre class="nocode">var log = Log.Instance;
log.LogReceived += OnLogReceived;
</pre><p>As you can see, the log is a singleton, so there is only one living instance of the Log class. It will probably live as long as the app itself. Now you might be thinking: what’s wrong with this code? Nothing, until the app starts growing and growing and your users start complaining about memory issues.</p>
<p>What happens here is that you subscribe to the LogReceived event of the Log class. This subscription contains 2 things:</p>
<ol>
<li>What class do I need to call (null for static, otherwise the instance of the class)</li>
<li>What method do I need to call</li>
</ol>
<p>So, in fact now the Log class knows about the instance of the class that just subscribed to it and holds a reference to it (how else can it deliver the event, if it doesn’t know the address). Thus, the classes that subscribe to the Log and that do no unsubscribe will never be collected by the garbage collection.</p>
<h2 id="open-instance-delegates">Open instance delegates<a class="headerlink" href="#open-instance-delegates" title="Permalink to this headline"><i class="fa fa-link" aria-hidden="true"></i></a></h2>
<p>The key feature behind this implementation of the weak event pattern is open instance delegates. You are probably wondering: what the hell are open instance delegates? Well, good question, and I will try to explain it. An open instance delegate is just as a regular delegate, it points to the method of a specific class, but the biggest difference is that it does not bind to a specific instance. This means that it can be described as: I know you live on that street (method), but I have not clue in which city (instance) that is. The instance can be specified later. The delegate for a regular event handler looks like this:</p>
<pre class="nocode">public delegate void OpenInstanceHandler(TTarget @this, object sender, TEventArgs e);
</pre><p>The @this is nothing special, it allows us to use the this keyword so everyone knows that the target should be passed there. As you can see, it contains 3 parameters. The first one is the target (the city), the second and third parameters are the parameters of the regular event handler.</p>
<h2 id="weak-references">Weak references<a class="headerlink" href="#weak-references" title="Permalink to this headline"><i class="fa fa-link" aria-hidden="true"></i></a></h2>
<p>The weak event listener creates an open instance delegate and stores both the source and target in a WeakReference class. As soon as one of these references are no longer valid, the class is unbound. The good side of this approach is that this weak event listener does not leak when the event never fires.</p>
<h2 id="what-does-it-support">What does it support<a class="headerlink" href="#what-does-it-support" title="Permalink to this headline"><i class="fa fa-link" aria-hidden="true"></i></a></h2>
<p>The following use cases are supported:</p>
<ul>
<li>Instance source (event) and instance target (handler)</li>
<li>Static source (event) and instance target (handler)</li>
<li>Instance source (event) and static target (handler)</li>
</ul>
<p>So, actually it handles everything that can cause a memory leak via event subscriptions!</p>
<h2 id="what-does-it-not-support-and-what-are-the-downsides">What does it not support and what are the downsides<a class="headerlink" href="#what-does-it-not-support-and-what-are-the-downsides" title="Permalink to this headline"><i class="fa fa-link" aria-hidden="true"></i></a></h2>
<p>This weak event listener follows the rules of the .NET framework. So, it cannot subscribe to private events. If you want private events, do your own hacking (the source is available, you only have to change the DefaultEventBindingFlags at the top of the class).</p>
<p>There are a few downsides about using a weak event listeners in general:</p>
<ul>
<li>It’s notation is ugly, the “original” .NET way looks way better</li>
<li>You have to name the event by string, that sucks (if you know a better way, contact me!)</li>
<li>It can only handle events with a handler of EventHandler&lt;TEventArgs&gt;</li>
<li>You become a lazy developer not caring about subscriptions</li>
</ul>
<h2 id="how-to-use">How to use<a class="headerlink" href="#how-to-use" title="Permalink to this headline"><i class="fa fa-link" aria-hidden="true"></i></a></h2>
<p>There are 4 categories of event subscriptions, all described below.</p>
<h3 id="instance-to-instance">Instance to instance<a class="headerlink" href="#instance-to-instance" title="Permalink to this headline"><i class="fa fa-link" aria-hidden="true"></i></a></h3>
<p>This is the situation where an instance target subscribes to an instance event. The events are unbound as soon as either the target or source are collected.</p>
<pre class="nocode">var source = new EventSource();
var listener = new EventListener();
var weakEventListener = WeakEventListener&lt;EventListener, EventSource, EventArgs&gt;.SubscribeToWeakEvent(listener, source, &quot;PublicEvent&quot;, listener.OnPublicEvent);
</pre><h3 id="instance-to-static">Instance to static<a class="headerlink" href="#instance-to-static" title="Permalink to this headline"><i class="fa fa-link" aria-hidden="true"></i></a></h3>
<p>This is the situation where a static target subscribes to an instance event. The events are unbound as soon as the source is collected.</p>
<pre class="nocode">var source = new EventSource();

var weakEventListener = WeakEventListener&lt;EventListener, EventSource, EventArgs&gt;.SubscribeToWeakEvent(null, source, &quot;PublicEvent&quot;, EventListener.OnEventStaticHandler);
</pre><h3 id="static-to-instance">Static to instance<a class="headerlink" href="#static-to-instance" title="Permalink to this headline"><i class="fa fa-link" aria-hidden="true"></i></a></h3>
<p>This is the situation where an instance target subscribes to a static event. The events are unbound as soon as the target is collected.</p>
<pre class="nocode">var listener = new EventListener();

var weakEventListener = WeakEventListener&lt;EventListener, EventSource, EventArgs&gt;.SubscribeToWeakEvent(listener, null, &quot;StaticEvent&quot;, listener.OnPublicEvent);
</pre><h3 id="static-to-static">Static to static<a class="headerlink" href="#static-to-static" title="Permalink to this headline"><i class="fa fa-link" aria-hidden="true"></i></a></h3>
<p>This is not supported because you shouldn’t be using a weak event listener here. Static events with static event handlers simply cannot cause memory leaks because both the source and the target have no instance. However, it might be possible that you subscribe to an event too many times and the event fires too many times. But again, no memory issues here.</p>

                    </div>
                </div>
                <footer>
                    <hr />
                    <div role="contentinfo">

                    </div>
                </footer>
            </div>
        </section>
    </div>
    <script src="../../js/jquery-2.1.1.min.js"></script>
    <script src="../../js/modernizr-2.8.3.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    <script src="../../js/theme.js"></script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    
      ga('create', 'UA-25600919-4', 'auto');
      ga('send', 'pageview');
    
    </script>
</body>
</html>
